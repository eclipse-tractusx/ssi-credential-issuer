################################################################################
# Copyright (c) 2025 Cofinity-X GmbH
# Copyright (c) 2025 Contributors to the Eclipse Foundation
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
# SPDX-License-Identifier: Apache-2.0
################################################################################

name: Reissue Expiring Credentials

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage/Environment'
        required: true
        type: choice
        default: 'int'
        options:
          - int
      log_level:
        description: 'Logging Level'
        required: false
        type: choice
        default: 'INFO'
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR
      limit:
        description: 'Maximum number of credentials to reissue (optional)'
        required: false
        type: string
      sap_url:
        description: 'SAP URL'
        required: true
        type: string
      sap_auth_url:
        description: 'SAP Auth URL'
        required: true
        type: string
      start_date:
        description: "yyyy-mm-dd, credentials expiring *on or after* this date (inclusive) will be reissued"
        required: true
        type: string
      end_date:
        description: "yyyy-mm-dd, credentials expiring *on or before* this date (inclusive) will be reissued"
        required: true
        type: string

jobs:
  reissue_expiring_credentials:
    runs-on:
      group: apps-stage
      labels: apps
    environment: ReissueExpiringCredentials

    steps:
    - name: Check out repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r environments/reissue_expiring_credentials/requirements.txt

    - name: Set environment secrets
      id: set-secrets
      run: |
        case "${{ github.event.inputs.stage }}" in
          int)
            echo "ISSUER_SERVICE_CLIENT_ID=${{ secrets.INT_ISSUER_SERVICE_CLIENT_ID }}" >> $GITHUB_ENV
            echo "ISSUER_SERVICE_CLIENT_SECRET=${{ secrets.INT_ISSUER_SERVICE_CLIENT_SECRET }}" >> $GITHUB_ENV
            echo "SAP_CLIENT_ID=${{ secrets.INT_SAP_CLIENT_ID }}" >> $GITHUB_ENV
            echo "SAP_CLIENT_SECRET=${{ secrets.INT_SAP_CLIENT_SECRET }}" >> $GITHUB_ENV
            ;;
          *)
            echo "Unknown environment: ${{ github.event.inputs.stage }}"
            exit 1
            ;;
        esac

    - name: Run reissue credentials script
      run: |
        LIMIT_ARG=""
        if [ -n "${{ github.event.inputs.limit }}" ]; then
          LIMIT_ARG="--limit ${{ github.event.inputs.limit }}"
        fi
        SAP_CLIENT_SECRET=$(echo "${{ env.SAP_CLIENT_SECRET }}" | base64 --decode)
        python environments/reissue_expiring_credentials/reissue_expiring_credentials.py \
          --stage "${{ github.event.inputs.stage }}" \
          --start_date ${{ github.event.inputs.start_date }} \
          --end_date ${{ github.event.inputs.end_date }} \
          --log-level "${{ github.event.inputs.log_level }}" \
          --issuer-service-client-id "${{ env.ISSUER_SERVICE_CLIENT_ID }}" \
          --issuer-service-client-secret "${{ env.ISSUER_SERVICE_CLIENT_SECRET }}" \
          --sap-url "${{ github.event.inputs.sap_url }}" \
          --sap-auth-url "${{ github.event.inputs.sap_auth_url }}" \
          --sap-client-id "$SAP_CLIENT_ID" \
          --sap-client-secret "$SAP_CLIENT_SECRET" \
          $LIMIT_ARG
